<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FINOVA - Financial Innovation App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    body { background-color: #f4f6f8; font-family: 'Segoe UI', sans-serif; }
    h1 { margin: 30px 0; text-align: center; color: #2d6a4f; font-weight: bold; }
    .chart-container { margin: 40px auto; max-width: 1000px; }
    table th, table td { text-align: center; }
    .table tfoot td { font-weight: bold; background: #e0f2f1; }
  </style>
</head>
<body>
  <div class="container">
    <h1>FINOVA - Dashboard Penyerapan Anggaran</h1>

    <input type="file" id="uploadCSV" accept=".csv" class="form-control mb-4" />

    <div class="table-responsive">
      <table class="table table-bordered table-striped" id="dataTable">
        <thead class="table-success">
          <tr>
            <th>Bidang</th>
            <th>Pagu Anggaran</th>
            <th>Realisasi Anggaran</th>
            <th>Sisa Anggaran</th>
            <th>Progres</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td>Total</td>
            <td id="totalPagu"></td>
            <td id="totalRealisasi"></td>
            <td id="totalSisa"></td>
            <td id="avgProgres"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="chart-container">
      <canvas id="chartAnggaran"></canvas>
    </div>
  </div>

  <script>
    document.getElementById('uploadCSV').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        delimiter: ";",
        skipEmptyLines: true,
        complete: function (results) {
          const data = results.data;
          populateTable(data);
          renderChart(data);
        }
      });
    });

    function populateTable(data) {
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = "";

      let totalPagu = 0, totalRealisasi = 0, totalSisa = 0, totalProgres = 0;

      data.forEach(row => {
        const progres = parseFloat(row["Progres"].replace('%', '').replace(',', '.'));

        totalPagu += parseInt(row["Pagu Anggaran"]);
        totalRealisasi += parseInt(row["Realisasi Anggaran"]);
        totalSisa += parseInt(row["Sisa Anggaran"]);
        totalProgres += progres;

        tbody.innerHTML += `
          <tr>
            <td>${row["Bidang"]}</td>
            <td>Rp ${Number(row["Pagu Anggaran"]).toLocaleString()}</td>
            <td>Rp ${Number(row["Realisasi Anggaran"]).toLocaleString()}</td>
            <td>Rp ${Number(row["Sisa Anggaran"]).toLocaleString()}</td>
            <td>${progres.toFixed(2)}%</td>
          </tr>`;
      });

      document.getElementById('totalPagu').textContent = `Rp ${totalPagu.toLocaleString()}`;
      document.getElementById('totalRealisasi').textContent = `Rp ${totalRealisasi.toLocaleString()}`;
      document.getElementById('totalSisa').textContent = `Rp ${totalSisa.toLocaleString()}`;
      document.getElementById('avgProgres').textContent = `${(totalProgres / data.length).toFixed(2)}%`;
    }

    function renderChart(data) {
      const labels = data.map(row => row["Bidang"]);
      const realisasi = data.map(row => parseInt(row["Realisasi Anggaran"]));

      const ctx = document.getElementById('chartAnggaran').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Realisasi Anggaran',
            data: realisasi,
            backgroundColor: 'rgba(40, 167, 69, 0.7)',
            borderColor: 'rgba(40, 167, 69, 1)',
            borderWidth: 1
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              min: 50000,
              ticks: {
                callback: value => 'Rp ' + value.toLocaleString()
              }
            }
          },
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: context => 'Rp ' + context.raw.toLocaleString()
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
